<!DOCTYPE html>
<head>	
	<script type="text/javascript" src="crafty.js"></script>
</head>
<body>
	<script type="text/javascript">
        var  unreadPost = true;
        var  npc_post = true;
        
		Crafty.init(700, 890);
        
        var color = 'rgb(255,0,0)';
        var p =0;
        var d=0;
        var a = 0;

        
        //turn the sprite maps into usable components
        Crafty.sprite(20, "cat.png", {
            cat: [0, 0],
            rev_cat:[0,1]
        });
        Crafty.sprite(20, "sprites_1.png", {
            inbrick: [0, 0],
            brick: [1, 0],
            window:[0, 1],
            roof1:[0,2,2,1],
            roof2:[0,3,2,1],
            roof3:[0,4],
            door:[0,5,1,2],
            indoor:[1,5,1,2],
        });
        Crafty.sprite(20, "examplenpc.png", {
            npc: [0, 0,1,2],
            rev_npc: [0,3,1,2]
        });
        Crafty.sprite(91, "Dolly.png", {
            dolly: [0, 0]  
        });         
        Crafty.sprite(100, "speak2.png", {
            greenpost: [0, 1],
            bluepost:[0,0,6,1]
        });
        
        Crafty.scene("loading", function () {
            //load takes an array of assets and a callback when complete
            Crafty.load(["cat.png", "bg.png", "sprites_1.png", "examplenpc.png", "speak2.png"], function () {
                Crafty.scene("main"); //when everything is loaded, run the main scene
            });
        
            //black background with some loading text
            //Crafty.background("#000");
            Crafty.e("2D, DOM, Text").attr({ w: 100, h: 20, x: 150, y: 120 })
                .text("Loading")
                .css({ "text-align": "center" });
        });
        
        //automatically play the loading scene
        Crafty.scene("loading");

        Crafty.scene("main", function () {
            Crafty.background( Crafty.e("2D, DOM, Image").image("bg.png"));
            
     



     
            //Player Post
            Crafty.e("Post, DOM, 2D,  Text, Delay , greenpost")
                .attr({ x: 50, y: 320 ,w:600, h: 100, z:10000, visible:false})
                .text("")
                
                .bind("EnterFrame", function () {
                    
                    if (unreadPost){
                        this.y = 320;
                        this.visible = true;
                        this.text(document.getElementById('PostBox').value);
                        this.textFont({ family: 'Arial', size:"40px" , weight: "bold"})
                        this.delay(function(){npc_post = true;},1500);
                        this.delay(function(){this.visible = false},3000);
                       unreadPost = false;
                       
                   }
                })
                
            //NPC Post
            Crafty.e("Post, DOM, 2D,  Text, Delay , bluepost")
                .attr({ x: 50, y: 320 ,w:600, h: 100,  z:10000, visible:false, speaker:"none"})
                .text("")
                
                .bind("EnterFrame", function () {
                    pst = document.getElementById('PostBox').value.toUpperCase();
                    if (npc_post){
                        Crafty("Post").each( function () {this.y -= 150;})
                        this.y = 320;
                        this.visible = true;
                        if (pst.indexOf("HELLO") >= 0){
                            this.text("Welcome Back");
                        }else if (pst.indexOf("SHEEP") >= 0 || (pst.indexOf("FARM") >= 0) || (pst.indexOf("CLONE") >= 0)){
                            var i = 0;
                            var j = pst.indexOf("SHEEP", i);
                            while (j > -1){
                               d += 1; 
                               i = j +1
                               j = pst.indexOf("SHEEP", i);
                            }
                            i = 0;
                            j = pst.indexOf("FARM", i);
                            while(j > -1){
                                d += 1; 
                                i = j +1
                                j = pst.indexOf("FARM", i);
                            }
                            i = 0;
                            j=pst.indexOf("CLONE", i);
                            while(j > -1){  
                               d += 1; 
                               i = j+1
                               j = pst.indexOf("CLONE", i);
                            }
                             speaker = "d";
                             this.text(":)");
                        }else if (pst.indexOf("CAT") >= 0 || (pst.indexOf("Bot") >= 0)){
                            var i = 0;
                            var j = pst.indexOf("CAT", i);
                            while (j > -1){
                               a += 1; 
                               i = j +1
                               j = pst.indexOf("CAT", i);
                               this.text("~Meow");
                            }
                            i = 0;
                            j = pst.indexOf("BOT", i);
                            while(j > -1){  
                               a -= 1; 
                               i = j+1
                               j = pst.indexOf("BOT ", i);
                               this.text("...")
                            }
                             speaker = "a";                         
                             
                        }else{
                             this.text("hmmm");
                        }
                        this.textFont({ family: 'Arial', size:"40px" , weight: "bold"})
                        this.delay(function(){this.visible = false},3000);
                       npc_post = false;
                   }
                })
                
            //Pallet item
            Crafty.c("Pallet_item" ,{
                init: function(){
                    this.requires('2D');
                },

                select:function () {
                    this.media = m;
                    Crafty("Brush").each(function () { 
                        this.media = m; 
                    })

                    
                }



                
            })  

            //pallet items
            Crafty.e('Media_0, 2D, DOM, brick, Mouse, Pallet_item')
                .attr({ x: 500, y: 820, w: 20, h: 20, media:0})       
                .bind("Click", function () {
                     
                    Crafty("Brush").each(function () { 
                        this.media = 0; 
                    })
                })
                
            Crafty.e('Media_1, 2D, DOM, window, Mouse')
                
                .attr({ x: 525, y: 820, w: 20, h: 20})
                       
                .bind("Click", function () {
                     
                    Crafty("Brush").each(function () { 
                        this.media = 1; 
                    })
                })

             Crafty.e("Media_2, 2D, DOM, cat, , Mouse")
                .attr({x: 545, y: 820 })
                       
                .bind("Click", function () {
                     
                    Crafty("Brush").each(function () { 
                        this.media = 2; 
                    })
                })
            Crafty.e('Media_3, 2D, DOM, roof1, Mouse')
                
                .attr({ x: 565, y: 820})
                       
                .bind("Click", function () {
                     
                    Crafty("Brush").each(function () { 
                        this.media = 3; 
                    })
                })

             Crafty.e("Media_4, 2D, DOM, roof3, Mouse")
                .attr({x: 610, y: 820 })
                       
                .bind("Click", function () {
                     
                    Crafty("Brush").each(function () { 
                        this.media = 4; 
                    })
                })

             Crafty.e("Media_5, 2D, DOM, roof2,  Mouse")
                .attr({x:635, y: 820 })
                       
                .bind("Click", function () {
                     
                    Crafty("Brush").each(function () { 
                        this.media = 5; 
                    })
                })
                
             Crafty.e("Media_6, 2D, DOM, door,  Mouse")
                .attr({x:680, y: 800 })
                       
                .bind("Click", function () {
                     
                    Crafty("Brush").each(function () { 
                        this.media = 6; 
                    })
                })

                Crafty.e("Media_7, 2D, DOM, inbrick,  Mouse")
                .attr({x:500, y: 860 })
                       
                .bind("Click", function () {
                     
                    Crafty("Brush").each(function () { 
                        this.media = 7; 
                    })
                })
                
             Crafty.e("Media_8, 2D, DOM, indoor,  Mouse")
                .attr({x:680, y: 840 })
                       
                .bind("Click", function () {
                     
                    Crafty("Brush").each(function () { 
                        this.media = 8; 
                    })
                })
                
                //Crafty.e("Save_Test, 2D, DOM, rev_cat,  Mouse")
                //.attr({x:30, y: 840 })
                       
                //.bind("Click", function () {
                   // var ent = Crafty.e("2D, DOM, Color")
                   //     .attr({x: 20, y: 20, w: 100, h:100})
                   //     .color(color);
                  //  Crafty.storage.open('MyGame');
                  //  Crafty.storage.save('MyEntity', 'save', ent);
                //})
                
                
            //Mover
            Crafty.c("Mover" ,{
                init: function(){
                    this.requires('SpriteAnimation');
                },

                
                    walk: function(){
                        //if(!this.isPlaying())
                        if( Crafty.math.randomInt(0, 5) < this.speed){
                            if(this.dX == 1 ){
                                this.animate('right', 3);
                            }else{
                                this.animate('left', 3);
                            }
                            if(this.x > 680 || this.x < 0){
                                this.turnAround();
                            }
                            else{
                                 if( Crafty.math.randomInt(0, 100) < this.turnFactor){
                                    this.turnAround();
                                 }else{
                                    this.x = this.x + this.dX;
                                }
                            }
                        }
                    },
                    
                turnAround: function(){
                        this.dX *= -1;
                        this.x = this.x + this.dX;
                }
            
            });
            
            //Floor            
            Crafty.e("Floor, 2D, DOM, Color, Solid, SuperSolid")
                .attr({x: 0, y: 780, w: 700, h: 20 })
                .color("green")

            //NPC            
            Crafty.e("NPC, 2D, DOM, npc, Collision, Mover")
                .attr({x: 0, y: 740, z:100, dX:1, speed:2, turnFactor:5})
                .animate('right', 0, 0, 3)
                .animate('left', 0, 2, 3)
                
                .bind("EnterFrame", function () {
                    this.walk();
                })
                .onHit("SuperSolid", function(){
                       this.turnAround();       
                })
                
                
         


            //Brush
            Crafty.e("Brush, 2D, DOM, Color, Multiway")
                .color(color)
                .attr({ x: 200, y: 200, w: 20, h: 20, z:100000, media: 0 })
                //.multiway(10, { UP_ARROW: -90, DOWN_ARROW: 90, LEFT_ARROW: 180, RIGHT_ARROW: 0 })
                
                .bind('EnterFrame', function () {
                   // hit floor or roof
                    if (this.y <= 20 )
                        this.y = 20;
                    if (this.y >= 860 )
                        this.y = 860;
                        
                                 
            
                    if (unreadPost){
                        pst = document.getElementById('PostBox').value;
                        Crafty("PlayerPost").text("    " + pst); 
                        unreadPost = false;
                                p += 100;
                        
                    }
                })                     

                .bind("KeyDown", function (e) {
                    

                    if (e.key == Crafty.keys['ENTER'] || e.key == Crafty.keys['SPACE']){    
                        if (this.media == 0){ 
                            if (p >= 10){
                                Crafty.e('2D, DOM, brick, Collision, Gravity, Solid, SuperSolid')
                                    //.color("blue")
                                    .attr({
                                    w: 20,
                                    h: 20,
                                    x: this.x,
                                    y: this.y
                                    })
                                    .gravity("Solid")
                                p -= 10;
                            }
                        } else if (this.media == 1){
                            if (p >= 10){
                                Crafty.e('2D, DOM,  window, SpriteAnimation, Collision, Gravity, Solid')
                                    .attr({
                                        w: 20,
                                        h: 20,
                                        x: this.x,
                                        y: this.y
                                    })
                                    .collision()
                                    .animate('window', 0, 1, 1)
                                    .bind("EnterFrame", function () {
                                        if(!this.isPlaying())
                                            this.animate('window', 800);
                                    })
                                    .gravity("Solid")
                                p-=10;
                            }                              
                        } else if(this.media == 2){
                            if (p >= 50){
                                Crafty.e("2D, DOM, cat, SpriteAnimation, Gravity, Collision, Mover")
                                    .attr({
                                    x: this.x,
                                    y: this.y,
                                    z: 100000,
                                    dX: 1,
                                    speed:5,
                                    turnFactor:1
                                    })

                                    .animate('right', 0, 0, 2)
                                    .animate('left', 0, 1, 2)
                                    
                                    .bind("EnterFrame", function () {
                                        this.walk();
                                    })
                                    .onHit("SuperSolid", function(){
                                           this.turnAround();       
                                    })
                                    .gravity("SuperSolid")
                                p -= 50;
                                a += 1; 
                            }
                        } else if(this.media == 3){
                            if (p >= 10){
                                Crafty.e("2D, DOM, roof1, Gravity, Solid, SuperSolid")
                                    .attr({
                                    x: this.x,
                                    y: this.y
                                    })
                                    .gravity("Solid")
                                p -= 10;
                             }
                        } else if(this.media == 4){
                            if (p >= 10){
                                Crafty.e("2D, DOM, roof3, Gravity, Solid, SuperSolid")
                                    .attr({
                                    x: this.x,
                                    y: this.y
                                    })
                                    .gravity("Solid")
                                p-=10;
                            }    
                        } else if(this.media == 5){
                            if (p >= 10){
                                Crafty.e("2D, DOM, roof2, Gravity, Solid, SuperSolid")
                                    .attr({
                                    x: this.x,
                                    y: this.y
                                    })
                                    .gravity("Solid")
                                p-=10;
                            }
                        }else if(this.media == 6){
                            if (p >= 20){
                                Crafty.e("2D, DOM, door, Gravity, Solid")
                                    .attr({
                                    x: this.x,
                                    y: this.y
                                    })
                                    .gravity("Solid")
                                p-=20;
                            }
                        }else if(this.media == 7){
                            if (p >= 10){
                                Crafty.e("2D, DOM, inbrick, Gravity, Solid")
                                    .attr({
                                    x: this.x,
                                    y: this.y
                                    })
                                    .gravity("Solid")
                                p-=10;    
                            }
                        }else if(this.media == 8){
                            if (p >= 20){
                                Crafty.e("2D, DOM, indoor, Gravity, Solid")
                                    .attr({
                                    x: this.x,
                                    y: this.y
                                    })
                                    .gravity("Solid")
                                p-=20;
                            }

                    }        
                    } else if (e.key == Crafty.keys['UP_ARROW'] || e.key == Crafty.keys['W']){
                            this.y = this.y - 20;
                    }else if (e.key == Crafty.keys['DOWN_ARROW'] || e.key == Crafty.keys['S']){
                            this.y = this.y + 20;
                    }else if (e.key == Crafty.keys['LEFT_ARROW'] || e.key == Crafty.keys['A']){
                            this.x = this.x - 20;
                    }else if (e.key == Crafty.keys['RIGHT_ARROW'] || e.key == Crafty.keys['D']){
                            this.x = this.x + 20;
                    }
                
             })
                    

        })
        
        function newPost(){
            unreadPost = true;
        }
        
         //Message 
        Crafty.e("Message, DOM")
            .bind("EnterFrame", function () {
                if (unreadPost){                     
                    p = p + 100;
               }
               document.getElementById('annameter').value =  a;
               document.getElementById('pointbox').value =  p;
               document.getElementById('dollymeter').value =  d;
            })
        
        //Crafty.addEntityFactory('Wall', function() {
        //      var entity = Crafty.e('2D, DOM, Color, Collision')
         //     .color("blue")
         //     .attr({
          //      w: 20,
            //    h: 20,
              //  x: Crafty("Brush").x,
               // y: Crafty("Brush").y
              //})
              //.addComponent('Gravity').gravity("Floor");

              //return entity;
            //})
    
	</script>
    <p>Post New Message: <input  id = "PostBox" name="post" value="   Hello!"><input type="button" value="Post!" onClick=newPost();> Current Points <input  id = "pointbox" name="poinbox" readonly="readonly" ></p>
    <p>Dolly: <input  id = "dollymeter" readonly="readonly" ></p> Anna: <input  id = "annameter" readonly="readonly" ></p>
</body>
</html>